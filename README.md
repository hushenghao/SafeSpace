# Androidä¸­çš„å®‰å…¨è·ç¦»é€‚é…

åœ¨Androidå±å¹•çš„ç©ºé—´ä¸­ï¼Œå¤§éƒ¨åˆ†çš„åŒºåŸŸæˆ‘ä»¬éƒ½æ˜¯å¯ä»¥éšæ„ç»˜åˆ¶ï¼Œåªæœ‰ä¸€éƒ¨åˆ†åŒºåŸŸæ˜¯æ˜¾ç¤ºçš„å›ºå®šå†…å®¹ï¼š

* **çŠ¶æ€æ **
* æ ‡é¢˜æ (ActionBar)
* é¡µé¢å†…å®¹(Content)
* **å¯¼èˆªæ **

å…¶ä¸­**æ ‡é¢˜æ **æ˜¯å¯é€‰çš„ï¼Œé™¤äº†Materialé£æ ¼çš„åº”ç”¨åº”ç”¨çš„å¹¶ä¸å¤šï¼Œ**é¡µé¢å†…å®¹**å°±æ˜¯`android.R.id.content`æ˜¯Activityçš„ä¸»è¦å†…å®¹ã€‚

è€Œæˆ‘ä»¬ä¸»è¦éœ€è¦è®¨è®ºçš„å°±æ˜¯ **çŠ¶æ€æ å’Œå¯¼èˆªæ **ï¼Œå› ä¸ºè¿™ä¸¤ä¸ªåŒºåŸŸåœ¨ä¸åŒè®¾å¤‡ç±»å‹ï¼Œä¸åŒçš„Androidç‰ˆæœ¬å’Œä¸åŒçš„å‚å•†ä¸‹å¤§å°å’Œæ•ˆæœæ˜¯ä¸åŒçš„ï¼Œç­‰ç­‰ã€‚è¿™äº›å·®å¼‚æ— ç–‘å¢åŠ äº†æˆ‘ä»¬åšé¡µé¢é€‚é…çš„å¤æ‚ç¨‹åº¦ï¼Œä¹Ÿæ›´å®¹æ˜“å‡ºç°å…¼å®¹é—®é¢˜ã€‚

åœ¨2017å¹´ä¸‹åŠå¹´iPhone Xçš„å‘å¸ƒï¼Œå¼•å…¥äº†åˆ˜æµ·å±è®¾å¤‡ï¼Œå¯¼è‡´äº†è“ç»¿å¤§å‚äº‰ç›¸æ•ˆä»¿ï¼ŒåŒæ—¶åˆè‡ªæˆä¸€æ´¾ï¼Œé¢‡æœ‰ä¸€ç•ªç™¾å®¶äº‰é¸£ä¹‹è±¡ã€‚
è¿™ä¹Ÿå¯¼è‡´äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ **åˆ˜æµ·åŒºåŸŸé€‚é…** ï¼Œé‚£æ—¶å€™Androidæ‰8.1ï¼Œå¹¶æ²¡æœ‰APIæ¥æ”¯æŒè¿™å±å¹•ä¸Šè¿™å¤šå‡ºæ¥çš„ä¸€å—åŒºåŸŸï¼Œä¸è¿‡å¥½åœ¨å¤§éƒ¨åˆ†è®¾å¤‡åœ¨å®šåˆ¶æ—¶**åˆ˜æµ·å’ŒçŠ¶æ€æ é«˜åº¦æ˜¯ä¸€è‡´çš„**ã€‚

ç»ˆäºåœ¨2018å¹´å‘å¸ƒçš„Android 9ä¸­Googleæ­£å¼æ”¯æŒäº†åˆ˜æµ·å±ï¼Œå®šåˆ¶äº†è§„èŒƒçº¦æŸäº†è®¾å¤‡å‚å•†ï¼Œå‡è½»äº†åˆ˜æµ·å±é€‚é…çš„å·®å¼‚é—®é¢˜ï¼Œä½†æ˜¯æ ¹æºé—®é¢˜å¹¶æ²¡æœ‰è§£å†³ã€‚å› ä¸ºåˆ˜æµ·åŒºåŸŸçš„å­˜åœ¨ï¼Œå¯èƒ½ä¼šå‡ºç°é¡µé¢å†…å®¹è¢«é®æŒ¡ï¼Œæ¯”å¦‚ï¼šå¯ç”¨é¡µå¹¿å‘Šè·³è¿‡æŒ‰é’®è¢«é®æŒ¡çš„é—®é¢˜ï¼Œå¯¼è‡´è¢«åº”ç”¨å•†åº—æ‹’æ‰çš„é£é™©ã€‚

ä¸è¿‡å¥½åœ¨Android 9ä¸­è¦æ±‚åˆ˜æµ·è®¾å¤‡å¿…é¡»æœ‰ä»¥ä¸‹è¡Œä¸ºï¼š

* ä¸€æ¡è¾¹ç¼˜æœ€å¤šåªèƒ½åŒ…å«ä¸€ä¸ªåˆ˜æµ·ã€‚
* ä¸€å°è®¾å¤‡ä¸èƒ½æœ‰ä¸¤ä¸ªä»¥ä¸Šçš„åˆ˜æµ·ã€‚
* è®¾å¤‡çš„ä¸¤æ¡è¾ƒé•¿è¾¹ç¼˜ä¸Šä¸èƒ½æœ‰åˆ˜æµ·ã€‚
* **åœ¨æœªè®¾ç½®ç‰¹æ®Šæ ‡å¿—çš„ç«–å±æ¨¡å¼ä¸‹ï¼ŒçŠ¶æ€æ çš„é«˜åº¦å¿…é¡»ä¸åˆ˜æµ·çš„é«˜åº¦æŒå¹³ã€‚**
* é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨å…¨å±æ¨¡å¼æˆ–æ¨ªå±æ¨¡å¼ä¸‹ï¼Œæ•´ä¸ªåˆ˜æµ·åŒºåŸŸå¿…é¡»æ˜¾ç¤ºé»‘è¾¹ã€‚

**åˆ˜æµ·é«˜åº¦é»˜è®¤æ˜¯å’ŒçŠ¶æ€æ é«˜åº¦ä¸€è‡´**ä¾æ—§æ²¡æœ‰å˜ï¼Œæ‰€ä»¥é—®é¢˜åˆå›åˆ°äº†çŠ¶æ€æ åŒºåŸŸçš„å¤„ç†ã€‚

## æ­£æ–‡

æ‰€ä»¥è‚¯å®šæœ‰åŒå­¦è¯´äº†ï¼šç›´æ¥è·å–çŠ¶æ€æ é«˜åº¦ä¸å°±å¯ä»¥äº†é€‚é…åˆ˜æµ·å±äº†ã€‚åƒè¿™æ ·ï¼š

```kotlin
val top = context.getStatusBarHeight()
titleBar.setPadding(0, top, 0, 0)
```

è¿™ä¹ˆè¯´ä¹Ÿæ²¡æœ‰é”™ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚ä½†æ˜¯æ—¢ç„¶å®˜æ–¹å·²ç»é€‚é…åˆ˜æµ·å±äº†ï¼Œä¹Ÿä¸ºæˆ‘ä»¬æä¾›äº†æ–°çš„APIä¸ºä»€ä¹ˆä¸ç”¨å‘¢ï¼š

```kotlin
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.P) {
    window.decorView.post {
        val top = window.decorView.rootWindowInsets?.displayCutout?.safeInsetTop ?: 0
        // val bottom = window.decorView.rootWindowInsets?.displayCutout?.safeInsetBottom ?: 0
        titleBar.setPadding(0, top, 0, 0)
    }
}
```

ä¸Šé¢çš„æ–¹æ¡ˆå®é™…ä¸Šå¯ä»¥è·å–ä¸Šä¸‹å·¦å³å››ä¸ªæ–¹å‘çš„å®‰å…¨è·ç¦»ï¼Œä½†å¤§éƒ¨åˆ†æƒ…å†µæˆ‘ä»¬åªéœ€è¦å¤„ç†é¡¶éƒ¨å°±å¯ä»¥äº†ã€‚å®é™…ä¸Šè¿™å·²ç»å¯ä»¥è§£å†³æˆ‘ä»¬çš„é—®é¢˜äº†ï¼Œä½†æ˜¯è¿˜æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆæ–¹æ¡ˆï¼š

1. æ·»åŠ ä¾èµ–
```gradle
implementation 'androidx.core:core:1.7.0'

// è€ç‰ˆæœ¬ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯getInsets() API è¿˜æ²¡æ·»åŠ 
// implementation 'androidx.core:core:1.3.0'
```
2. ä½¿ç”¨ViewCompatå·¥å…·
```kotlin
ViewCompat.setOnApplyWindowInsetsListener(titleBar) { view: View, insets: WindowInsetsCompat ->
    //val top = insets.systemWindowInsetTop // é«˜ç‰ˆæœ¬å·²ç»è¿‡æ—¶ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„apiæ›¿æ¢
    val stableInsets = insets.getInsets(
    WindowInsetsCompat.Type.systemBars() or WindowInsetsCompat.Type.displayCutout())
    titleBar.setPadding(0, stableInsets.top, 0, 0)
    return@setOnApplyWindowInsetsListener insets
}
```

å®é™…ä¸Šå±å¹•å®‰å…¨è·ç¦»ï¼ŒåŸºæœ¬ä¸Šå…¨éƒ¨å›´ç»•è¿™ä¸€ä¸ªAPIï¼ŒGoogleä¹Ÿæ¨èæˆ‘ä»¬è¿™ä¹ˆåšï¼Œåœ¨å¾ˆå¤šç³»ç»Ÿæ§ä»¶éƒ½èƒ½çœ‹åˆ°å®ƒçš„å½±å­ï¼Œæ¯”å¦‚ï¼š`AppBarLayoutã€DrawerLayoutã€NavigationBarView`ç­‰ç­‰éƒ½æœ‰ç”¨åˆ°ï¼Œå†…éƒ¨éƒ½æ˜¯æ¥å¤„ç†ç³»ç»Ÿå®‰å…¨è·ç¦»çš„ã€‚

### ç³»ç»Ÿæ é€‚é…

ä¸Šé¢æåˆ°äº†æ‰‹æœºæœ‰å„ç§ç³»ç»Ÿæ ï¼ˆçŠ¶æ€æ ã€å¯¼èˆªæ ï¼‰ï¼Œå¦‚æœä¸€ä¸ª**å…¨å±+åˆ˜æµ·å±+é€æ˜ç³»ç»Ÿæ +å±å¹•æ—‹è½¬**çš„é¡µé¢å¤„ç†è¿™äº›å®‰å…¨è·ç¦»å°±æ›´å¤æ‚ï¼Œæ¯”å¦‚çŸ­è§†é¢‘é¡µï¼Œè¿™é‡Œå…ˆç»™å¤§å®¶åˆ—å‡ æ¡å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š

* æ²¡æœ‰å¯¼èˆªæ æˆ–è€…å¯ä»¥åŠ¨æ€éšè—å¯¼èˆªæ çš„è®¾å¤‡
* å¯¼èˆªæ ä¸ä¼šæ—‹è½¬çš„è®¾å¤‡ï¼ˆå°±æ˜¯å¯¼èˆªæ ä¸€ç›´åœ¨å±å¹•çš„ä¸€ä¸ªè¾¹ï¼Œä¸ä¼šè·Ÿéšå±å¹•æ—‹è½¬ï¼‰
* å¯¼èˆªæ è·Ÿéšå±å¹•æ—‹è½¬çš„è®¾å¤‡ï¼ˆä¸»è¦æ˜¯æ‰‹åŠ¿å¯¼èˆªçš„è®¾å¤‡å’Œä¸€äº›å¹³æ¿ä¸Šï¼‰
* åˆ˜æµ·åœ¨å±å¹•åº•éƒ¨çš„è®¾å¤‡ï¼ˆå¼€å‘è€…é€‰é¡¹å¯ä»¥å¼€å¯åŒåˆ˜æµ·æ¨¡å¼ï¼Œè®¾å¤‡ä¸¤ä¸ªçŸ­è¾¹éƒ½æœ‰åˆ˜æµ·ï¼‰
* åº•éƒ¨åˆ˜æµ·+å¯¼èˆªæ ä¸€èµ·æ˜¾ç¤ºçš„è®¾å¤‡
* ... ...

è¿™äº›æ‰€æœ‰çš„é—®é¢˜é€šè¿‡ `ViewCompat.setOnApplyWindowInsetsListener()` æ¥ä¼˜é›…å¤„ç†ï¼Œ
é€šè¿‡ `WindowInsetsCompat.getInsets(type)` å¯ä»¥è·å–ç³»ç»Ÿçš„å„ä¸ªæ çš„å¤§å°ï¼Œ
æˆ‘ä»¬ä¹Ÿå¯ä»¥åŒæ—¶è·å–å¤šä¸ªç³»ç»Ÿæ çš„é«˜åº¦ï¼Œå„ä¸ªè·ç¦»å†…éƒ¨ä¼šè¿›è¡Œç´¯åŠ ï¼Œè¿”å›ä¸€ä¸ªç±»ä¼¼Rectçš„å¯¹è±¡ï¼Œå¯¹åº”å±å¹•çš„å·¦ä¸Šå³ä¸‹éœ€è¦æ’å…¥çš„è·ç¦»ï¼š
```kotlin
val stableInsets = insets.getInsets(
    WindowInsetsCompat.Type.statusBars() or
    WindowInsetsCompat.Type.navigationBars() or
    WindowInsetsCompat.Type.displayCutout())
```
ç„¶ååœ¨å¯¹ä¸åŒä½ç½®çš„æ§ä»¶æ·»åŠ å¯¹åº”çš„è¾¹è·ã€‚é™¤äº†ä¸Šé¢æåˆ°çš„ä¸‰ç§ç±»å‹çš„å®‰å…¨è·ç¦»ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç±»å‹ï¼Œæœ‰å…´è¶£çš„å¯ä»¥è‡ªå·±äº†è§£ã€‚

### å…¶ä»–é€‚é…

`ViewCompat.setOnApplyWindowInsetsListener()`èƒ½è§£å†³å¤§éƒ¨åˆ†å®‰å…¨è·ç¦»çš„é—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹å®ƒæ˜¯å¤„ç†ä¸äº†çš„ï¼Œå°±æ˜¯ **å±å¹•åœ†è§’**ï¼Œè¿™äº›å®‰å…¨è·ç¦»çš„è®¡ç®—æ˜¯ä¸å¤„ç†å±å¹•åœ†è§’çš„ï¼Œæ‰€ä»¥å¦‚æœæœ‰åœ†è§’è¦å¤„ç†é‚£æˆ‘ä»¬å°±è¦å¦è¾Ÿè¹Šå¾„äº†ã€‚

å¥½åœ¨Android 12ä¸­å®˜æ–¹æ·»åŠ äº†å¯¹åœ†è§’çš„æ”¯æŒï¼š

```kotlin
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
    val roundedCorner = insets.toWindowInsets()
        ?.getRoundedCorner(RoundedCorner.POSITION_TOP_LEFT)
    roundedCorner?.center
}
```
ä½†æ˜¯æˆ‘ç”¨äº†Pixel4çœŸæœºå‘ç°å¹¶ä¸èƒ½è·å–åˆ°æ•°æ®ğŸ˜‚ï¼ŒåŒ…æ‹¬æ¨¡æ‹Ÿå™¨ä¹Ÿä¸€æ ·ã€‚

é™¤äº†åœ†è§’æ”¯æŒï¼Œè¿˜æœ‰å¯¹**éšç§æŒ‡ç¤ºå™¨**æä¾›äº†æ”¯æŒï¼š
```kotlin
if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.S) {
    val rect = insets.toWindowInsets()?.privacyIndicatorBounds
    // é¡µé¢æ§ä»¶éœ€è¦é¿å¼€è¿™ä¸ªåŒºåŸŸï¼Œä¸ç„¶å¯èƒ½ä¼šè¢«é®æŒ¡
}
```
éšç§æŒ‡ç¤ºå™¨çš„èŒƒå›´ï¼Œä¸»è¦æ˜¯ **æ‘„åƒå¤´å’Œéº¦å…‹é£** ä½¿ç”¨ä¸­çŠ¶æ€çš„æŒ‡ç¤ºå™¨è¾¹ç•Œï¼Œå¦‚æœæ˜¯å½•åˆ¶ç›´æ’­æˆ–è€…ç›¸æœºçš„é¡µé¢éœ€è¦å¤„ç†è¿™ä¸ªåŒºåŸŸã€‚

é™¤äº†åœ†è§’ä»¥å¤–ï¼Œå¥½åƒæ²¡æœ‰æ‰¾åˆ°å®˜æ–¹å¯¹**æ‰“å­”å±**çš„æ”¯æŒï¼Œå¯èƒ½åé¢ä¼šåŠ å…¥å¯¹æ‰“å­”å±çš„æ”¯æŒå§ã€‚

## ç›¸å…³é“¾æ¥

[Demo](https://github.com/hushenghao/SafeSpace)

[å®˜æ–¹æ–‡æ¡£ï¼šæ”¯æŒåˆ˜æµ·å±](https://developer.android.google.cn/guide/topics/display-cutout)

[å®˜æ–¹æ–‡æ¡£ï¼šåœ†è§’](https://developer.android.google.cn/guide/topics/ui/look-and-feel/rounded-corners)